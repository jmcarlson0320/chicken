pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
--main
SUB_PIXEL = 8
DX_MAX_WALK = 20
DX_MAX_RUN = 36

function _init()
	box = create_test_box(64, 64)
end

function _update()
	update_box(box)
end

function _draw()
	cls()
	map()
	draw_box(box)
	--[[
	print("subx:      "..player.sub_x)
	print("x:         "..player.x)
	print("dx:        "..player.dx)
	print("target_dx: "..player.target_dx)
	print("suby:      "..player.sub_y)
	print("y:         "..player.y)
	print("dy:        "..player.dy)
	print("btn:       "..btn())
	print("state:     "..player.state)
	]]
end

function create_test_box(x, y)
	return {
		x = x,
		y = y,
		dx = 0,
		dy = 0,
	}
end

function update_box(b)
end

function draw_box(b)
	rect(b.x, b.y, b.x+7, b.y+7, 8)
end

function create_player(x, y)
	local p = {
		x = x,
		y = y,
		sub_x = x * SUB_PIXEL,
		sub_y = y * SUB_PIXEL,
		dx = 0,
		dy = 0,
		target_dx = 0,
		target_dy = 0,
		brakes_on = false,
		state = "idle",
		animations = {
			["idle"] = {
				frames = {50},
				rate = 0,
				t = 0,
			},
			["walk"] = {
				frames = {49, 50, 51, 50},
				rate = 4,
				t = 0,
			},
			["run"] = {
				frames = {49, 50, 51, 50},
				rate = 2,
				t = 0,
			},
		},
		facing = "right",
	}

	return p
end

function player_update(p)
	if p.state == "idle" then
		if btn(0) then
			p.target_dx = -DX_MAX_WALK
			p.facing = "left"
			p.state = "walk"
		end
		if btn(1) then
			p.target_dx = DX_MAX_WALK
			p.facing = "right"
			p.state = "walk"
		end
		if btn(4) then
			p.dy = -16
			p.airborne = true
		end
	elseif p.state == "walk" then
		-- left
		if btn(0) then
			p.target_dx = -DX_MAX_WALK
			p.facing = "left"
		end
		-- right
		if btn(1) then
			p.target_dx = DX_MAX_WALK
			p.facing = "right"
		end
		-- run left
		if btn(5) and btn(0) then
			p.target_dx = -DX_MAX_RUN
			p.state = "run"
		end
		-- run right
		if btn(5) and btn(1) then
			p.target_dx = DX_MAX_RUN
			p.state = "run"
		end
		-- coasting
		if btn() & 0x0F == 0 then
			p.target_dx = 0
		end
		-- not moving
		if (btn() & 0x0F == 0) and (p.dx == 0) then
			p.state = "idle"
		end
	elseif p.state == "run" then
		-- run left
		if btn(0) then
			p.target_dx = -DX_MAX_RUN
			p.facing = "left"
		end
		-- run right
		if btn(1) then
			p.target_dx = DX_MAX_RUN
			p.facing = "right"
		end
		-- released run or direction
		if (btn() & 0x0F == 0) or (not btn(5)) then
			p.state = "walk"
		end
	end

	-- X movement
	--	vel += acc
	--	pos += vel
	if p.target_dx - p.dx ~= 0 then
		local acc = sgn(p.target_dx - p.dx)
		if (p.target_dx > 0 and p.dx < 0) or (p.target_dx < 0 and p.dx > 0) then
			acc *= 2
		end
		p.dx += acc -- vel += acc
	end

	p.sub_x += p.dx -- pos += vel
	p.x = p.sub_x \ SUB_PIXEL

	p.sub_y += p.dy
	p.y = p.sub_y \ SUB_PIXEL

	if p.airborne then
		p.dy += 1
		local tile_x = p.x \ 8
		local tile_y = p.y \ 8 + 1
		local tile_below_player = mget(tile_x, tile_y)
		if fget(tile_below_player) == 1 then
			local a = {x1=p.x, y1=p.y, x2=(p.x + 7), y2=(p.y + 7)}
			local b = {x1=(tile_x * 8), y1=(tile_y * 8), x2=(tile_x * 8 + 7), y2=(tile_y * 8 + 7)}
			if collide(a, b) then
				p.y -= 1
				p.sub_y = p.y * SUB_PIXEL
				p.dy = 0
				p.airborne = false
			end
		end
	end

end

function player_draw(p)
	local anim = p.animations[p.state]
	local index = flr(anim.t / anim.rate % #anim.frames) + 1
	local sprite = anim.frames[index]
	local flip_x = p.facing == "left"
	spr(sprite, p.x, p.y, 1, 1, flip_x)
	anim.t += 1
end

function collide(a, b)
	if a.x1 > b.x2 then return false end
	if b.x1 > a.x2 then return false end
	if a.y1 > b.y2 then return false end
	if b.y1 > a.y2 then return false end
	return true
end
__gfx__
00000000007777777777777777777700007777777777777777777700000000000000000000000000000000000000000000000000000000000000000000000000
00000000077777777777777777777770077777777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000
00700700777777777777777777777777770000000000000000000077000000000000000000000000000000000000000000000000000000000000000000000000
00077000770000000000000000000077700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000
00077000700000000000000000000007070000000000000000000070000000000000000000000000000000000000000000000000000000000000000000000000
00700700700000000000000000000007007777777777777777777700000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000070000000000000000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007777777777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000008000008080000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000808000777777000080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000077777700700c07007777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000700c070070000700700c070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000070000700700007a07000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000700007a077777700700007a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000077777700007000007777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007070000007000000707000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
